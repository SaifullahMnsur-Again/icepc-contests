<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ICEPC Contests - Contests</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        };
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen flex flex-col">
    <!-- Navigation Bar -->
    <nav class="bg-indigo-600 dark:bg-indigo-800 text-white p-4 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <h1 class="text-2xl sm:text-3xl font-bold">ICEPC Contests</h1>
            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4 items-start sm:items-center w-full sm:w-auto">
                <a href="index.html" class="text-white hover:text-indigo-200">Home</a>
                <a href="coders.html" class="text-white hover:text-indigo-200">Coders</a>
                <a href="contests.html" class="text-white font-semibold hover:text-indigo-200">Contests</a>
                <button onclick="toggleDarkMode()" class="w-full sm:w-auto px-4 py-2 text-sm rounded-md bg-indigo-700 dark:bg-indigo-400 dark:text-gray-900 hover:bg-indigo-800 dark:hover:bg-indigo-300">Toggle Theme</button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-10 flex-grow">
        <section id="contests">
            <h2 id="contest-title" class="text-3xl sm:text-4xl font-bold mb-2">
                <a href="#" id="contest-link" class="text-indigo-700 dark:text-indigo-300 hover:underline">Contest Name</a>
            </h2>
            <p id="contest-date" class="text-lg text-gray-600 dark:text-gray-300">Date and Time</p>
            <p id="contest-description" class="text-lg text-gray-600 dark:text-gray-300 mb-2">Short description of the contest.</p>
            <p id="contest-problem-setters" class="text-lg text-gray-600 dark:text-gray-300 mb-4">Problem Setter(s): N/A</p>
            <!-- Contest Switcher -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                <div class="flex items-center gap-2">
                    <label for="contest-select" class="font-semibold">Select Contest:</label>
                    <select id="contest-select" class="px-3 py-2 rounded-md border border-gray-300 dark:bg-gray-800 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500"></select>
                </div>
                <input id="filterInput" type="text" placeholder="Filter by name..." class="w-full sm:w-auto px-3 py-2 rounded-md border border-gray-300 dark:bg-gray-800 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
            <!-- Rank Table -->
            <div class="overflow-x-auto bg-white dark:bg-gray-800 shadow rounded-2xl">
                <table id="rank-table" class="min-w-full text-sm text-left border-collapse">
                    <thead class="bg-indigo-100 dark:bg-gray-700 dark:text-white">
                        <tr>
                            <th class="px-3 sm:px-4 py-3 border-b">Rank</th>
                            <th class="px-3 sm:px-4 py-3 border-b">Name</th>
                            <th class="px-3 sm:px-4 py-3 border-b">Solved</th>
                            <th class="px-3 sm:px-4 py-3 border-b">Penalty</th>
                            <!-- Dynamic problem columns -->
                        </tr>
                    </thead>
                    <tbody id="rank-table-body" class="divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-indigo-800 dark:bg-indigo-900 text-white p-4">
        <div class="max-w-7xl mx-auto text-center">
            <p>Â© 2025 ICEPC Contests. All rights reserved.</p>
        </div>
    </footer>

    <script>
        const CODERS_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vS_rvXyZpvU4zsqMZ10-px2NULkBw5rfCTGUD2HHVYDAjUdZuDuxbgjtkjGtIWHD-lPkvHzLjlnC9Tq/pub?gid=0&single=true&output=csv";
        const CONTEST_METADATA_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSXSB-zO1tuSWPCZEgENWdwJJezIyqmlksdwAulBsawNFVekKYlGn6dS0imxMq5qRNjHtB8MUWF0QLX/pub?gid=1861808501&single=true&output=csv"; // Replace with actual Google Sheet CSV URL

        async function fetchWithRetry(url, retries = 3, delay = 1000) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, { cache: 'no-store' });
                    if (!response.ok) {
                        const error = new Error(`HTTP error: ${response.status}`);
                        error.status = response.status;
                        throw error;
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1 || error.status !== 404) throw error;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function fetchContests() {
            try {
                const response = await fetchWithRetry(CONTEST_METADATA_CSV_URL);
                const csv = await response.text();
                const parsed = Papa.parse(csv.trim(), {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false
                });
                if (parsed.errors.length > 0) {
                    throw new Error(`CSV parsing errors: ${parsed.errors.map(e => e.message).join(', ')}`);
                }
                return parsed.data.map(row => ({
                    name: row.name || 'Unknown Contest',
                    date: row.date || 'Unknown Date',
                    description: row.description || 'No description available.',
                    sheet: row.sheet || '',
                    link: row.link || '#',
                    problem_setters: row.problem_setters || 'N/A'
                })).filter(contest => contest.sheet);
            } catch (error) {
                console.error('Error fetching contest metadata:', error);
                return [
                    {
                        name: 'ICE Coders Drill #26',
                        date: '2025-05-30 10:00',
                        description: 'ICE Coders Drill #26 competitive programming contest',
                        sheet: 'YOUR_CONTEST_CSV_URL_HERE',
                        link: '#',
                        problem_setters: 'N/A'
                    }
                ];
            }
        }

        async function fetchCoders() {
            try {
                const response = await fetchWithRetry(CODERS_CSV_URL);
                const csv = await response.text();
                const parsed = Papa.parse(csv.trim(), {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false
                });
                if (parsed.errors.length > 0) {
                    throw new Error(`CSV parsing errors: ${parsed.errors.map(e => e.message).join(', ')}`);
                }
                return parsed.data.reduce((map, coder) => {
                    if (coder.Vjudge && coder.Name && coder.Name.trim() !== '') {
                        map[coder.Vjudge] = coder.Name;
                    }
                    return map;
                }, {});
            } catch (error) {
                console.warn('Error fetching coders data, using empty map:', error);
                return {};
            }
        }

        function parseSubmission(submission) {
            if (!submission || submission.trim() === '') return { isSolved: false, seconds: 0, incorrect: 0 };
            // Match HH:MM:SS\n(-N) or HH:MM:SS
            const solvedMatch = submission.match(/^(\d+):(\d{2}):(\d{2})(\n\(-(\d+)\))?$/);
            if (solvedMatch) {
                const hours = parseInt(solvedMatch[1], 10);
                const minutes = parseInt(solvedMatch[2], 10);
                const seconds = parseInt(solvedMatch[3], 10);
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                const incorrect = solvedMatch[5] ? parseInt(solvedMatch[5], 10) : 0;
                return { isSolved: true, seconds: totalSeconds, incorrect };
            }
            // Match (-N)
            const unsolvedMatch = submission.match(/^\(-(\d+)\)$/);
            if (unsolvedMatch) {
                return { isSolved: false, seconds: 0, incorrect: parseInt(unsolvedMatch[1], 10) };
            }
            return { isSolved: false, seconds: 0, incorrect: 0 };
        }

        async function loadContestData(sheetUrl, contest) {
            const tbody = document.getElementById('rank-table-body');
            tbody.innerHTML = `<tr><td colspan="100" class="px-3 sm:px-4 py-2 border-b text-center text-gray-500">Loading...</td></tr>`;
            try {
                const response = await fetchWithRetry(sheetUrl);
                const csv = await response.text();
                const parsed = Papa.parse(csv.trim(), {
                    header: true,
                    skipEmptyLines: true,
                    dynamicTyping: false
                });

                if (parsed.errors.length > 0) {
                    throw new Error(`CSV parsing errors: ${parsed.errors.map(e => e.message).join(', ')}`);
                }

                const data = parsed.data;
                if (!data || data.length === 0) {
                    throw new Error('No valid data rows found in CSV');
                }

                const headers = Object.keys(data[0] || {});
                if (headers.length < 4) {
                    throw new Error('Insufficient headers in CSV');
                }

                document.getElementById('contest-title').innerHTML = `<a href="${contest.link}" class="text-indigo-700 dark:text-indigo-300 hover:underline">${contest.name}</a>`;
                document.getElementById('contest-date').textContent = contest.date;
                document.getElementById('contest-description').textContent = contest.description;
                document.getElementById('contest-problem-setters').textContent = `Problem Setter(s): ${contest.problem_setters}`;

                const thead = document.querySelector('#rank-table thead tr');
                thead.innerHTML = `
                    <th class="px-6 py-3 border-b">Rank</th>
                    <th class="px-3 sm:px-4 py-3 border-b">Name</th>
                    <th class="px-3 sm:px-4 py-3 border-b">Vjudge</th>
                    <th class="px-6 py-3 border-b">Solved</th>
                    <th class="px-6 py-3 border-b">Penalty</th>`;
                const problemColumns = headers
                    .slice(4)
                    .map(col => {
                        if (!col || typeof col !== 'string') return '';
                        const match = col.match(/([A-Za-z])\s*(\d+)\s*\/\s*(\d+)/);
                        return match ? `${match[1]} (${match[2]}/${match[3]})` : col;
                    })
                    .filter(col => col);
                problemColumns.forEach(col => {
                    const th = document.createElement('th');
                    th.className = 'px-2 sm:px-4 py-2 border-b';
                    th.textContent = col;
                    thead.appendChild(th);
                });

                // Find first solver for each problem
                const firstSolvers = {};
                problemColumns.forEach((_, colIndex) => {
                    const colName = headers[4 + colIndex] || '';
                    let earliestTime = Infinity;
                    let earliestRowIndex = -1;
                    data.forEach((row, rowIndex) => {
                        const submission = row[colName] || '';
                        const { isSolved, seconds } = parseSubmission(submission);
                        if (isSolved && seconds < earliestTime) {
                            earliestTime = seconds;
                            earliestRowIndex = rowIndex;
                        }
                    });
                    if (earliestRowIndex !== -1) {
                        firstSolvers[colName] = earliestRowIndex;
                    }
                });

                const vjudgeToName = await fetchCoders();
                tbody.innerHTML = '';
                let currentRank = 1;
                data.forEach((row, rowIndex) => {
                    const team = row['Team'] || '';
                    const score = row['Score'] || '0';
                    if (!team) return;
                    // Parse vjudge handle: nightmarexx1(sadnan404) -> nightmarexx1
                    const vjudgeHandleMatch = team.match(/^([^\(]+)\(/);
                    const vjudgeHandle = vjudgeHandleMatch ? vjudgeHandleMatch[1].trim() : team;
                    const name = vjudgeToName[vjudgeHandle];
                    // Skip if vjudge handle has no valid name
                    if (!name || name.trim() === '') return;

                    // Calculate total penalty (only for solved problems)
                    let totalSeconds = 0;
                    problemColumns.forEach((_, colIndex) => {
                        const colName = headers[4 + colIndex] || '';
                        const submission = row[colName] || '';
                        const { isSolved, seconds, incorrect } = parseSubmission(submission);
                        if (isSolved) {
                            totalSeconds += seconds + incorrect * 1200; // 20 minutes = 1200 seconds
                        }
                    });
                    const totalPenalty = Math.floor(totalSeconds / 60);

                    let rowHtml = `
                        <tr class="hover:bg-gray-100 dark:hover:bg-gray-700">
                            <td class="px-6 py-2 border-b">${currentRank}</td>
                            <td class="px-3 sm:px-4 py-2 border-b">${name}</td>
                            <td class="px-6 py-2 border-b"><a href="https://vjudge.net/user/${vjudgeHandle}" class="text-indigo-600 dark:text-indigo-400 hover:underline" target="_blank">${vjudgeHandle}</a></td>
                            <td class="px-6 py-2 border-b">${score}</td>
                            <td class="px-6 py-2 border-b">${totalPenalty}</td>`;
                    problemColumns.forEach((_, colIndex) => {
                        const colName = headers[4 + colIndex] || '';
                        const cellValue = row[colName] || '';
                        const { isSolved, incorrect } = parseSubmission(cellValue);
                        let cellClass = '';
                        if (isSolved) {
                            const isFirstSolver = firstSolvers[colName] === rowIndex;
                            cellClass = isFirstSolver
                                ? 'bg-green-500 dark:bg-green-700'
                                : 'bg-green-100 dark:bg-green-900';
                        } else if (incorrect > 0) {
                            cellClass = 'bg-gray-100 dark:bg-gray-700';
                        }
                        rowHtml += `<td class="px-2 sm:px-4 py-2 border-b ${cellClass}">${cellValue}</td>`;
                    });
                    rowHtml += '</tr>';
                    tbody.innerHTML += rowHtml;
                    currentRank++;
                });

                if (tbody.innerHTML === '') {
                    tbody.innerHTML = `<tr><td colspan="100" class="px-3 sm:px-4 py-2 border-b text-center text-gray-500">No valid participants found with matching vjudge handles.</td></tr>`;
                }

                document.getElementById('filterInput').addEventListener('input', (e) => {
                    const filter = e.target.value.toLowerCase();
                    const rows = tbody.querySelectorAll('tr');
                    let visibleRank = 1;
                    rows.forEach(row => {
                        const name = row.children[1] ? row.children[1].textContent.toLowerCase() : '';
                        if (name.includes(filter)) {
                            row.style.display = '';
                            row.children[0].textContent = visibleRank++;
                        } else {
                            row.style.display = 'none';
                        }
                    });
                });

                document.getElementById('rank-table').style.display = 'table';
            } catch (error) {
                let errorMessage = `Error loading contest data: ${error.message}`;
                if (error.status === 404) {
                    errorMessage += '. Please verify the contest CSV URL in the metadata sheet.';
                }
                console.error('Error fetching contest data:', error.message, { sheetUrl, error });
                document.getElementById('rank-table-body').innerHTML = `<tr><td colspan="100" class="px-3 sm:px-4 py-2 border-b text-center text-red-500">${errorMessage}</td></tr>`;
            }
        }

        async function loadContestDropdown() {
            const contests = await fetchContests();
            const select = document.getElementById('contest-select');
            select.innerHTML = '';
            contests.forEach(contest => {
                const option = document.createElement('option');
                option.value = JSON.stringify(contest);
                option.textContent = contest.name;
                select.appendChild(option);
            });
            select.addEventListener('change', () => {
                const selectedContest = JSON.parse(select.value);
                loadContestData(selectedContest.sheet, selectedContest);
            });
            if (contests.length > 0) {
                loadContestData(contests[0].sheet, contests[0]);
            } else {
                document.getElementById('rank-table-body').innerHTML = `<tr><td colspan="100" class="px-3 sm:px-4 py-2 border-b text-center text-red-500">No contests available. Please check the contest metadata CSV.</td></tr>`;
            }
        }

        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        }

        // Load saved theme
        if (localStorage.getItem('theme') === 'light') {
            document.documentElement.classList.remove('dark');
        }

        loadContestDropdown();
    </script>
</body>
</html>